# Development container for Xaheen CLI Ecosystem Web App
FROM node:20-alpine

# Install system dependencies
RUN apk add --no-cache \
    git \
    curl \
    bash \
    zsh \
    openssh-client \
    docker-cli \
    postgresql-client \
    redis \
    ca-certificates \
    && rm -rf /var/cache/apk/*

# Install Oh My Zsh
RUN sh -c "$(curl -fsSL https://raw.github.com/ohmyzsh/ohmyzsh/master/tools/install.sh)" "" --unattended

# Create non-root user
RUN addgroup -g 1000 node && adduser -u 1000 -G node -s /bin/zsh -D node

# Install global npm packages
RUN npm install -g \
    pnpm@latest \
    turbo@latest \
    @next/codemod \
    @storybook/cli \
    playwright \
    commitizen \
    conventional-changelog-cli

# Set up workspace
WORKDIR /workspace

# Copy package files for dependency installation
COPY package*.json ./
COPY pnpm-lock.yaml ./

# Install dependencies
RUN pnpm install --frozen-lockfile

# Set up git configuration
RUN git config --global init.defaultBranch main
RUN git config --global user.name "Xaheen Developer"
RUN git config --global user.email "dev@xaheen-ai.no"

# Set ownership
RUN chown -R node:node /workspace

# Switch to non-root user
USER node

# Install Playwright browsers
RUN npx playwright install --with-deps chromium

# Set up development environment
WORKDIR /workspace/apps/web

# Expose ports
EXPOSE 3000 3001

# Default command
CMD ["npm", "run", "dev"]