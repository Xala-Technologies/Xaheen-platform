# Redis Configuration for Xaheen CLI
# Norwegian Enterprise Grade with High Availability and Security

# =============================================================================
# Network and Security Configuration
# =============================================================================

# Bind to all interfaces for Kubernetes deployment
bind 0.0.0.0

# Default port
port 6379

# Security - require password authentication
requirepass ${REDIS_PASSWORD}

# Norwegian compliance - enable TLS for data in transit
tls-port 6380
tls-cert-file /tls/tls.crt
tls-key-file /tls/tls.key
tls-ca-cert-file /tls/ca.crt
tls-dh-params-file /tls/redis.dh

# TLS security settings
tls-protocols "TLSv1.2 TLSv1.3"
tls-ciphersuites "TLS_AES_256_GCM_SHA384:TLS_CHACHA20_POLY1305_SHA256:TLS_AES_128_GCM_SHA256"
tls-prefer-server-ciphers yes

# Disable non-TLS port in production
port 0

# TCP keepalive for Norwegian network conditions
tcp-keepalive 300

# Client timeout
timeout 0

# =============================================================================
# Memory and Performance Configuration
# =============================================================================

# Maximum memory usage (will be overridden by Kubernetes limits)
maxmemory 1gb

# Eviction policy for Norwegian compliance (prefer data retention)
maxmemory-policy allkeys-lru

# Memory sampling for eviction
maxmemory-samples 5

# Enable lazy freeing for better performance
lazyfree-lazy-eviction yes
lazyfree-lazy-expire yes
lazyfree-lazy-server-del yes
replica-lazy-flush yes

# Threading configuration for multi-core performance
io-threads 4
io-threads-do-reads yes

# =============================================================================
# Persistence Configuration for Norwegian Compliance
# =============================================================================

# Enable AOF for durability (Norwegian data retention requirements)
appendonly yes
appendfilename "appendonly.aof"

# AOF sync policy for data safety
appendfsync everysec

# No delay on fsync
no-appendfsync-on-rewrite no

# AOF rewrite configuration
auto-aof-rewrite-percentage 100
auto-aof-rewrite-min-size 64mb

# Enable RDB snapshots for backup
save 900 1    # Save if at least 1 key changed in 900 seconds
save 300 10   # Save if at least 10 keys changed in 300 seconds  
save 60 10000 # Save if at least 10000 keys changed in 60 seconds

# RDB configuration
dbfilename dump.rdb
dir /data

# Compress RDB files
rdbcompression yes
rdbchecksum yes

# =============================================================================
# Replication Configuration (for HA)
# =============================================================================

# Replica configuration
# replica-serve-stale-data yes
# replica-read-only yes
# repl-diskless-sync no
# repl-diskless-sync-delay 5

# Replication safety
min-replicas-to-write 1
min-replicas-max-lag 10

# =============================================================================
# Security Hardening for NSM Compliance
# =============================================================================

# Disable dangerous commands for Norwegian security requirements
rename-command FLUSHDB ""
rename-command FLUSHALL ""
rename-command KEYS ""
rename-command PEXPIRE ""
rename-command DEL "NSM_DEL_CMD"
rename-command CONFIG "NSM_CONFIG_CMD"
rename-command SHUTDOWN "NSM_SHUTDOWN_CMD"
rename-command DEBUG ""
rename-command EVAL ""
rename-command SCRIPT ""

# Protected mode (require authentication)
protected-mode yes

# Disable Lua scripting for security
lua-time-limit 0

# =============================================================================
# Logging Configuration for Norwegian Compliance
# =============================================================================

# Log level for production
loglevel notice

# Log to stdout for container logging
logfile ""

# Syslog configuration for Norwegian audit requirements
syslog-enabled yes
syslog-ident redis-xaheen-cli
syslog-facility local0

# =============================================================================
# Norwegian Compliance Specific Settings
# =============================================================================

# Client output buffer limits for large Norwegian text data
client-output-buffer-limit normal 0 0 0
client-output-buffer-limit replica 256mb 64mb 60
client-output-buffer-limit pubsub 32mb 8mb 60

# Query buffer limit
client-query-buffer-limit 1gb

# Protocol buffer limit
proto-max-bulk-len 512mb

# =============================================================================
# Monitoring and Metrics
# =============================================================================

# Enable latency monitoring
latency-monitor-threshold 100

# Slow log configuration for performance monitoring
slowlog-log-slower-than 10000
slowlog-max-len 128

# =============================================================================
# Norwegian Locale and Character Set Support
# =============================================================================

# Character set configuration for Norwegian text
# (Redis handles UTF-8 by default, but ensure proper encoding)

# Key expiration precision for GDPR compliance
active-expire-items-per-second 20

# =============================================================================
# Advanced Configuration
# =============================================================================

# Hash configuration for Norwegian text optimization
hash-max-ziplist-entries 512
hash-max-ziplist-value 64

# List configuration
list-max-ziplist-size -2
list-compress-depth 0

# Set configuration
set-max-intset-entries 512

# Sorted set configuration
zset-max-ziplist-entries 128
zset-max-ziplist-value 64

# HyperLogLog configuration
hll-sparse-max-bytes 3000

# Stream configuration for real-time Norwegian applications
stream-node-max-bytes 4096
stream-node-max-entries 100

# =============================================================================
# High Availability Configuration
# =============================================================================

# Sentinel configuration (if using Redis Sentinel)
# These would be configured separately in Sentinel nodes

# Cluster configuration (if using Redis Cluster)
# cluster-enabled yes
# cluster-config-file nodes.conf
# cluster-node-timeout 15000
# cluster-replica-validity-factor 10
# cluster-migration-barrier 1
# cluster-require-full-coverage yes

# =============================================================================
# Performance Tuning for Norwegian Infrastructure
# =============================================================================

# TCP backlog for Norwegian network conditions
tcp-backlog 511

# Disable transparent huge pages warning
always-show-logo no

# Stop writes on background save errors
stop-writes-on-bgsave-error yes

# Increase client connections for Norwegian enterprise load
maxclients 10000

# Database count (default is sufficient for most cases)
databases 16

# =============================================================================
# Norwegian Time Zone Configuration
# =============================================================================

# Note: Redis doesn't have built-in timezone support
# Application layer should handle Norwegian timezone (Europe/Oslo)
# Timestamps should be stored as UTC and converted in application

# =============================================================================
# Monitoring Integration
# =============================================================================

# Enable Redis metrics for Prometheus integration
# This requires redis_exporter sidecar container

# Disable default stats (will be collected by exporter)
# These settings optimize for external monitoring

# =============================================================================
# Security Audit Trail
# =============================================================================

# Log all commands for Norwegian compliance audit
# Note: This can impact performance, consider carefully
# syslog-enabled yes (already configured above)

# Log slow queries for security analysis
slowlog-log-slower-than 10000

# =============================================================================
# Emergency and Disaster Recovery
# =============================================================================

# Background save on shutdown
shutdown-on-sigint nosave
shutdown-on-sigterm save

# Automatic failover settings
replica-priority 100

# Data safety on crashes
crash-log-enabled yes
crash-memcheck-enabled yes

# =============================================================================
# Norwegian GDPR Compliance Notes
# =============================================================================

# For GDPR compliance:
# 1. Implement data expiration policies in application layer
# 2. Use EXPIRE commands for automatic data deletion
# 3. Implement right to erasure through DEL commands
# 4. Log all data access for audit trails
# 5. Encrypt sensitive data before storing in Redis
# 6. Use TLS for all connections (configured above)
# 7. Regular backup and secure storage of backup data

# Example GDPR-compliant data storage pattern:
# SET user:12345:session "{encrypted_session_data}" EX 3600
# SET user:12345:cache "{encrypted_cache_data}" EX 86400

# =============================================================================
# Performance Monitoring Commands
# =============================================================================

# Commands to monitor Redis performance:
# INFO stats
# INFO memory  
# INFO persistence
# INFO replication
# INFO clients
# LATENCY GRAPH
# SLOWLOG GET
# CLIENT LIST

# =============================================================================
# Configuration Validation
# =============================================================================

# Validate configuration on startup
config-sanitize-dump-payload yes

# Norwegian compliance validation
# - TLS enabled: yes
# - Authentication required: yes
# - Dangerous commands disabled: yes
# - Persistence enabled: yes
# - Monitoring enabled: yes
# - Security hardening applied: yes