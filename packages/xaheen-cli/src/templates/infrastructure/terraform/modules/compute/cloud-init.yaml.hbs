#cloud-config
# Cloud-init configuration for Azure VMs
# Generated by Xaheen CLI Terraform Generator
# Project: {{project_name}}
# Environment: {{environment}}

package_update: true
package_upgrade: true

packages:
  - docker.io
  - docker-compose
  - nginx
  - nodejs
  - npm
  - curl
  - wget
  - unzip
  - jq

groups:
  - docker

system_info:
  default_user:
    groups: [docker]

write_files:
  - path: /etc/nginx/sites-available/health
    content: |
      server {
          listen 80;
          server_name _;
          
          location /health {
              access_log off;
              return 200 "OK\n";
              add_header Content-Type text/plain;
          }
          
          location / {
              root /var/www/html;
              index index.html index.htm;
          }
      }
    permissions: '0644'
  
  - path: /var/www/html/health
    content: |
      OK
    permissions: '0644'

runcmd:
  # Start and enable Docker
  - systemctl start docker
  - systemctl enable docker
  
  # Configure nginx
  - ln -sf /etc/nginx/sites-available/health /etc/nginx/sites-enabled/default
  - systemctl start nginx
  - systemctl enable nginx
  
  # Install Azure CLI
  - curl -sL https://aka.ms/InstallAzureCLIDeb | bash
  
  # Install Azure Monitor agent
  - wget https://github.com/microsoft/OMS-Agent-for-Linux/releases/download/OMSAgent_v1.14.7-0/omsagent-1.14.7-0.universal.x64.sh
  - chmod +x omsagent-1.14.7-0.universal.x64.sh
  
  # Log completion
  - echo "Cloud-init completed successfully for {{project_name}}-{{environment}}" | logger -t cloud-init

final_message: "Cloud-init setup completed for {{project_name}} {{environment}} environment"