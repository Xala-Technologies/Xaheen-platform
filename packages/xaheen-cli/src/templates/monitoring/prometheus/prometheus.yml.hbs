# Prometheus 3.0 Configuration for {{projectName}}
# Generated by Xaheen CLI - Story 4.3 Monitoring and Observability
# Features: {{#each features}}{{this}} {{/each}}

global:
  scrape_interval: {{prometheus.scrapeInterval}}
  evaluation_interval: {{prometheus.evaluationInterval}}
  external_labels:
    environment: '{{environment}}'
    project: '{{projectName}}'
    cluster: '{{#if kubernetes}}{{kubernetes.namespace}}{{else}}standalone{{/if}}'
    
  {{#if prometheus.remoteWriteConfig}}
  # Remote write configuration for long-term storage
  remote_write:
    - url: {{prometheus.remoteWriteConfig.url}}
      {{#if prometheus.remoteWriteConfig.headers}}
      headers:
        {{#each prometheus.remoteWriteConfig.headers}}
        {{@key}}: "{{this}}"
        {{/each}}
      {{/if}}
      {{#if prometheus.remoteWriteConfig.basicAuth}}
      basic_auth:
        username: {{prometheus.remoteWriteConfig.basicAuth.username}}
        password: {{prometheus.remoteWriteConfig.basicAuth.password}}
      {{/if}}
      queue_config:
        capacity: 500
        max_shards: 1000
        min_shards: 1
        max_samples_per_send: 100
        batch_send_deadline: 5s
        min_backoff: 30ms
        max_backoff: 100ms
      retry_on_http_429: true
  {{/if}}

# Rule files
rule_files:
  - "rules/*.yml"
  - "alerts/*.yml"

# Alerting configuration
alerting:
  alertmanagers:
    - static_configs:
        - targets:
          {{#if features.includes('alertmanager')}}
          - alertmanager:9093
          {{else}}
          - localhost:9093
          {{/if}}
      timeout: 10s
      api_version: v2

# Scrape configurations
scrape_configs:
  # Application metrics
  {{#each prometheus.serviceDiscovery.staticConfigs}}
  - job_name: '{{jobName}}'
    static_configs:
      - targets:
        {{#each targets}}
        - {{this}}
        {{/each}}
        {{#if labels}}
        labels:
          {{#each labels}}
          {{@key}}: "{{this}}"
          {{/each}}
        {{/if}}
    metrics_path: {{metricsPath}}
    scrape_interval: {{scrapeInterval}}
    scrape_timeout: 10s
    honor_timestamps: true
    honor_labels: false
  {{/each}}

  # Self-monitoring
  - job_name: 'prometheus'
    static_configs:
      - targets: ['localhost:9090']
    scrape_interval: 15s
    metrics_path: /metrics

  {{#if features.includes('node-exporter')}}
  # Node Exporter - System metrics
  - job_name: 'node-exporter'
    static_configs:
      - targets: ['node-exporter:9100']
    scrape_interval: 15s
    relabel_configs:
      - source_labels: [__address__]
        target_label: instance
        regex: '([^:]+)(:[0-9]+)?'
        replacement: '${1}'
  {{/if}}

  {{#if features.includes('cadvisor')}}
  # cAdvisor - Container metrics
  - job_name: 'cadvisor'
    static_configs:
      - targets: ['cadvisor:8080']
    scrape_interval: 15s
    metrics_path: /metrics
    relabel_configs:
      - source_labels: [__meta_docker_container_name]
        target_label: container_name
      - source_labels: [__meta_docker_container_label_com_docker_compose_service]
        target_label: service_name
  {{/if}}

  {{#if features.includes('blackbox-exporter')}}
  # Blackbox Exporter - Endpoint monitoring
  - job_name: 'blackbox-http'
    metrics_path: /probe
    params:
      module: [http_2xx]
    static_configs:
      - targets:
        - http://localhost:3000/health
        - https://{{projectName}}.example.com/health
    relabel_configs:
      - source_labels: [__address__]
        target_label: __param_target
      - source_labels: [__param_target]
        target_label: instance
      - target_label: __address__
        replacement: blackbox-exporter:9115

  - job_name: 'blackbox-tcp'
    metrics_path: /probe
    params:
      module: [tcp_connect]
    static_configs:
      - targets:
        - localhost:3000
        - database:5432
    relabel_configs:
      - source_labels: [__address__]
        target_label: __param_target
      - source_labels: [__param_target]
        target_label: instance
      - target_label: __address__
        replacement: blackbox-exporter:9115
  {{/if}}

  {{#if features.includes('otel-collector')}}
  # OpenTelemetry Collector metrics
  - job_name: 'otel-collector'
    static_configs:
      - targets: ['otel-collector:8888']
    scrape_interval: 30s
    metrics_path: /metrics
  {{/if}}

  {{#if prometheus.serviceDiscovery.kubernetes}}
  # Kubernetes service discovery configurations
  
  # API Server
  - job_name: 'kubernetes-apiservers'
    kubernetes_sd_configs:
      - role: endpoints
        namespaces:
          names:
            - default
            {{#if kubernetes}}
            - {{kubernetes.namespace}}
            {{/if}}
    scheme: https
    tls_config:
      ca_file: /var/run/secrets/kubernetes.io/serviceaccount/ca.crt
      insecure_skip_verify: false
    bearer_token_file: /var/run/secrets/kubernetes.io/serviceaccount/token
    relabel_configs:
      - source_labels: [__meta_kubernetes_namespace, __meta_kubernetes_service_name, __meta_kubernetes_endpoint_port_name]
        action: keep
        regex: default;kubernetes;https
      - target_label: __address__
        replacement: kubernetes.default.svc:443
      - source_labels: [__meta_kubernetes_service_name]
        target_label: job
        replacement: apiserver

  # Nodes
  - job_name: 'kubernetes-nodes'
    kubernetes_sd_configs:
      - role: node
    scheme: https
    tls_config:
      ca_file: /var/run/secrets/kubernetes.io/serviceaccount/ca.crt
      insecure_skip_verify: true
    bearer_token_file: /var/run/secrets/kubernetes.io/serviceaccount/token
    relabel_configs:
      - action: labelmap
        regex: __meta_kubernetes_node_label_(.+)
      - target_label: __address__
        replacement: kubernetes.default.svc:443
      - source_labels: [__meta_kubernetes_node_name]
        regex: (.+)
        target_label: __metrics_path__
        replacement: /api/v1/nodes/${1}/proxy/metrics

  # Node Exporter through Kubernetes
  - job_name: 'kubernetes-nodes-exporter'
    kubernetes_sd_configs:
      - role: node
    scheme: https
    tls_config:
      ca_file: /var/run/secrets/kubernetes.io/serviceaccount/ca.crt
      insecure_skip_verify: true
    bearer_token_file: /var/run/secrets/kubernetes.io/serviceaccount/token
    relabel_configs:
      - action: labelmap
        regex: __meta_kubernetes_node_label_(.+)
      - target_label: __address__
        replacement: kubernetes.default.svc:443
      - source_labels: [__meta_kubernetes_node_name]
        regex: (.+)
        target_label: __metrics_path__
        replacement: /api/v1/nodes/${1}/proxy/metrics/cadvisor

  # Service Discovery for Pods
  - job_name: 'kubernetes-pods'
    kubernetes_sd_configs:
      - role: pod
        namespaces:
          names:
            - default
            {{#if kubernetes}}
            - {{kubernetes.namespace}}
            {{/if}}
    relabel_configs:
      - source_labels: [__meta_kubernetes_pod_annotation_prometheus_io_scrape]
        action: keep
        regex: true
      - source_labels: [__meta_kubernetes_pod_annotation_prometheus_io_path]
        action: replace
        target_label: __metrics_path__
        regex: (.+)
      - source_labels: [__address__, __meta_kubernetes_pod_annotation_prometheus_io_port]
        action: replace
        regex: ([^:]+)(?::\d+)?;(\d+)
        replacement: ${1}:${2}
        target_label: __address__
      - action: labelmap
        regex: __meta_kubernetes_pod_label_(.+)
      - source_labels: [__meta_kubernetes_namespace]
        action: replace
        target_label: kubernetes_namespace
      - source_labels: [__meta_kubernetes_pod_name]
        action: replace
        target_label: kubernetes_pod_name
      - source_labels: [__meta_kubernetes_pod_container_name]
        action: replace
        target_label: container_name

  # Service Discovery for Services
  - job_name: 'kubernetes-services'
    kubernetes_sd_configs:
      - role: service
        namespaces:
          names:
            - default
            {{#if kubernetes}}
            - {{kubernetes.namespace}}
            {{/if}}
    relabel_configs:
      - source_labels: [__meta_kubernetes_service_annotation_prometheus_io_scrape]
        action: keep
        regex: true
      - source_labels: [__meta_kubernetes_service_annotation_prometheus_io_path]
        action: replace
        target_label: __metrics_path__
        regex: (.+)
      - source_labels: [__address__, __meta_kubernetes_service_annotation_prometheus_io_port]
        action: replace
        regex: ([^:]+)(?::\d+)?;(\d+)
        replacement: ${1}:${2}
        target_label: __address__
      - action: labelmap
        regex: __meta_kubernetes_service_label_(.+)
      - source_labels: [__meta_kubernetes_namespace]
        action: replace
        target_label: kubernetes_namespace
      - source_labels: [__meta_kubernetes_service_name]
        action: replace
        target_label: kubernetes_service_name

  {{#if kubernetes.serviceMonitors}}
  # ServiceMonitor discovery (Prometheus Operator)
  - job_name: 'kubernetes-service-monitors'
    kubernetes_sd_configs:
      - role: endpoints
        namespaces:
          names:
            {{#if kubernetes}}
            - {{kubernetes.namespace}}
            {{/if}}
    relabel_configs:
      - source_labels: [__meta_kubernetes_service_label_app_kubernetes_io_name]
        action: keep
        regex: prometheus
      - source_labels: [__meta_kubernetes_endpoint_port_name]
        action: keep
        regex: web
      - source_labels: [__address__]
        target_label: __param_target
      - source_labels: [__param_target]
        target_label: instance
      - target_label: __address__
        replacement: prometheus-operator-prometheus:9090
  {{/if}}
  {{/if}}

# Storage configuration
storage:
  tsdb:
    path: /prometheus
    retention.time: {{prometheus.retentionTime}}
    retention.size: 10GB
    no-lockfile: false
    wal-compression: true
    # Enable exemplar storage for distributed tracing correlation
    max-exemplars: 100000
    
# Web configuration
web:
  enable-lifecycle: true
  enable-admin-api: false
  external-url: {{#if environment}}{{#eq environment 'production'}}https://prometheus.{{projectName}}.com{{else}}http://localhost:9090{{/eq}}{{else}}http://localhost:9090{{/if}}
  route-prefix: /
  max-connections: 512
  read-timeout: 30s
  
# Feature flags for Prometheus 3.0
feature-flags:
  - promql-at-modifier
  - remote-write-receiver
  - exemplar-storage
  - memory-snapshot-on-shutdown
  {{#if features.includes('distributed-tracing')}}
  - otlp-write-receiver
  {{/if}}

# Tracing configuration (Prometheus 3.0 feature)
{{#if features.includes('distributed-tracing')}}
tracing:
  endpoint: "{{#if features.includes('jaeger')}}jaeger:14268/api/traces{{else if features.includes('tempo')}}tempo:4318/v1/traces{{else}}otel-collector:4318/v1/traces{{/if}}"
  service_name: "prometheus-{{projectName}}"
  insecure: true
  timeout: 2s
{{/if}}