# {{framework}} Application Dockerfile
{{#if multiStage}}
# Build stage
FROM node:{{nodeVersion}}-alpine AS builder

WORKDIR /app

# Copy package files
COPY package*.json ./
{{#if packageManager.pnpm}}
COPY pnpm-lock.yaml ./
{{/if}}
{{#if packageManager.yarn}}
COPY yarn.lock ./
{{/if}}

{{#if packageManager.pnpm}}
# Install pnpm
RUN npm install -g pnpm

# Install dependencies
RUN pnpm install --frozen-lockfile
{{else if packageManager.yarn}}
# Install dependencies
RUN yarn install --frozen-lockfile
{{else}}
# Install dependencies
RUN npm ci
{{/if}}

# Copy source code
COPY . .

{{#if buildCommand}}
# Build the application
RUN {{buildCommand}}
{{/if}}

# Production stage
FROM node:{{nodeVersion}}-alpine AS runner
{{else}}
FROM node:{{nodeVersion}}-alpine
{{/if}}

WORKDIR /app

# Create non-root user
RUN addgroup --system --gid 1001 nodejs
RUN adduser --system --uid 1001 nextjs

{{#if multiStage}}
# Copy built application
COPY --from=builder --chown=nextjs:nodejs /app/.next/standalone ./
COPY --from=builder --chown=nextjs:nodejs /app/.next/static ./.next/static
{{#if hasPublic}}
COPY --from=builder --chown=nextjs:nodejs /app/public ./public
{{/if}}
{{else}}
# Copy package files
COPY package*.json ./
{{#if packageManager.pnpm}}
COPY pnpm-lock.yaml ./
{{/if}}
{{#if packageManager.yarn}}
COPY yarn.lock ./
{{/if}}

{{#if packageManager.pnpm}}
# Install pnpm
RUN npm install -g pnpm

# Install dependencies
RUN pnpm install --prod --frozen-lockfile
{{else if packageManager.yarn}}
# Install dependencies
RUN yarn install --prod --frozen-lockfile
{{else}}
# Install dependencies
RUN npm ci --omit=dev
{{/if}}

# Copy source code
COPY . .

# Change ownership
RUN chown -R nextjs:nodejs /app

{{#if buildCommand}}
# Build the application
RUN {{buildCommand}}
{{/if}}
{{/if}}

# Switch to non-root user
USER nextjs

# Expose port
EXPOSE {{port}}

{{#if healthCheck}}
# Health check
HEALTHCHECK --interval=30s --timeout=3s --start-period=5s --retries=3 \
  CMD curl -f http://localhost:{{port}}/{{healthCheck.endpoint}} || exit 1
{{/if}}

# Start the application
CMD ["{{startCommand}}"]